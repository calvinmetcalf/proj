{"ts":1343929058729,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"//set the options\r\nvar center = new L.LatLng(42.3584308,-71.0597732);\r\nvar zoom = 8;\r\nvar url= \"http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png\";\r\nvar ac;\r\nvar sw=0;\r\nvar options={\r\n        subdomains:[\"otile1\",\"otile2\",/*\"otile3\",*/\"otile4\"],//we'd usually use all 4 but something is up with #3 at the moment\r\n        attribution:\"Tiles Courtesy of <a href='http://www.mapquest.com/' target='_blank'>MapQuest</a> <img src='http://developer.mapquest.com/content/osm/mq_logo.png'>\"\r\n    };\r\n//create the tiles    \r\nvar tiles = new L.TileLayer(url,options);\r\n//create the map\r\nvar m = new L.Map('map',{\r\n    center:center,\r\n    zoom:zoom,\r\n    layers:[tiles]\r\n    });\r\nvar gj =   L.geoJson({ \"type\": \"FeatureCollection\",  \"features\": []},{pointToLayer:pl,onEachFeature:gjon}).addTo(m);\r\nvar lu= L.geoJson({ \"type\": \"FeatureCollection\",  \"features\": []},{pointToLayer:pl,onEachFeature:luon}).addTo(m);\r\n\r\nfunction luon(e,l) {\r\n    if (e.properties){\r\n        l.bindPopup(makePop(e.properties));\r\n    }if(l.setStyles){\r\n     l.setStyle({color:\"#0000ff\",fillOpacity:1,opacity:1});   \r\n    }\r\n};\r\n//create empty geojson object and add it to the map\r\n\r\n//create the popups\r\nfunction gjon(e,l) {\r\n    if (e.properties){\r\n        l.bindPopup(makePop(e.properties));\r\n    }\r\n    if(e.properties.Progress&&l.setStyle){\r\n       if(e.properties.Progress==3){\r\n        l.setStyle({color:\"#ff0000\",fillOpacity:0.8,opacity:1});   \r\n       }else if(e.properties.Progress==2){\r\n        l.setStyle({color:\"#ffff00\",fillOpacity:0.8,opacity:1});   \r\n       }else if(e.properties.Progress==1){\r\n        l.setStyle({color:\"#00ff00\",fillOpacity:0.8,opacity:1});   \r\n       }\r\n    }else if(e.properties.Progress&&l.setIcon){\r\n       if(e.properties.Progress==3){\r\n        l.setIcon(icon.red);   \r\n       }else if(e.properties.Progress==2){\r\n        l.setIcon(icon.yellow);   \r\n       }else if(e.properties.Progress==1){\r\n        l.setIcon(icon.green);   \r\n       }\r\n    }\r\n}\r\n\r\nvar icon={\r\n    red:L.icon({iconUrl:\"img/red.png\",iconSize: L.point(9, 9)}),\r\n    yellow:L.icon({iconUrl:\"img/yellow.png\",iconSize:  L.point(9, 9)}),\r\n    green:L.icon({iconUrl:\"img/green.png\",iconSize:  L.point(9, 9)})\r\n}\r\n//get the current bounds\r\nvar bbox=/*m.getBounds().toBBoxString();*/\"-76.1627197265625,40.052847601823984,-65.9564208984375,44.57873024377564\";\r\n//the url. note we're only getting a subset of fields\r\nvar url = {};\r\nurl.line = \"http://services.massdot.state.ma.us/ArcGIS/rest/services/Projects/Project_Lines/MapServer/0/query?\"\r\nurl.point = \"http://services.massdot.state.ma.us/ArcGIS/rest/services/Projects/Project_Points/MapServer/0/query?\"\r\nurl.fields=\"ProjectNumber,District,Location,ProjectType,CompletionDate,BudgetSource,Department,Progress\"\r\nurl.where={\"Status\":\"Active\"};\r\nurl.setW=function(k,v){\r\n url.where[k]=v;   \r\n}\r\nurl.rmW=function(k){\r\n    delete url.where[k]\r\n}\r\nurl.getW=function(){\r\n    var a = [];\r\n for(var k in url.where){\r\n     a.push(k+\"%3D%27\"+url.where[k]+\"%27\")\r\n }\r\n return a.join(\"%20AND%20\")\r\n}\r\nurl.end = \"&f=json&outSR=4326&inSR=4326&geometryType=esriGeometryEnvelope&geometry=\"\r\n//get the features\r\ngetLayers(bbox);\r\n//this is the call back from the jsonp ajax request\r\nfunction parseJSONP(data){\r\n/*you'd think you'd want to put the command to clear the old layer here instead of after zooming, but the markers are not not visible when you zoom, so it ends up being much less noticeable clearing them earlier*/\r\ntoGeoJSON(data,function(d){gj.addData(d)});\r\nmakeAuto(data);\r\n}\r\n//set up listeners on both drag and zoom events\r\n//m.on(\"dragend\",redo);\r\n//m.on(\"zoomend\",redo);\r\n//the function called by those event listeners\r\nfunction redo(){\r\n    //bbox=m.getBounds().toBBoxString();\r\n    gj.clearLayers();//clear the current layers\r\n   getLayers(bbox);//ajax request\r\n}\r\n//the function called earlier to make the popup, it goes through all the attributes and makes them into a nice key value list\r\nfunction makePop(p){\r\nvar a = [];\r\n for(var key in p){\r\n     a.push(key+\": \"+p[key]);\r\n }\r\n return a.join(\"<br/>\");\r\n};\r\nfunction getLayers(bbox){\r\n    ac={};\r\n    $.get(url.point+\"outFields=\"+url.fields+\"&where=\"+url.getW()+url.end+bbox,parseJSONP,\"JSONP\");\r\n    $.get(url.line+\"outFields=\"+url.fields+\"&where=\"+url.getW()+url.end+bbox,parseJSONP,\"JSONP\");\r\n}\r\nfunction pl(f,latlng){\r\n    return L.marker(latlng);\r\n}\r\n$(function() {\r\n        $( \"#tabs\" ).tabs({\r\n        collapsible: true,\r\n            selected: -1\r\n        });\r\n       $( \"input:submit,input:reset\" ).button();\r\n        $('input, textarea').placeholder();\r\n});\r\nvar marker = new L.Marker();\r\nvar old={};\r\nfunction geocode(){\r\n    old.center=m.getCenter();\r\n    old.zoom=m.getZoom();\r\n var address =$(\"#address\").val();\r\n var gURL = 'http://open.mapquestapi.com/nominatim/v1/search?countrycodes=us&exclude_place_ids=955483008,950010827&viewbox=-76.212158203125%2C44.46123053905882%2C-66.005859375%2C40.107487419012415&bounded=1&format=json&q='\r\n  $.ajax({\r\n       type: \"GET\",\r\n       url: gURL + address,\r\n       dataType: 'jsonp',\r\n       jsonp: 'json_callback',\r\n       success: function (data, textStatus) {\r\n           if(textStatus==\"success\"){\r\n          var latlng = new L.LatLng(data[0].lat, data[0].lon);\r\n         marker.setLatLng(latlng);\r\n        \r\n         m.addLayer(marker);\r\n         m.setView(latlng,17);\r\n      \r\n           }\r\n       }\r\n  });\r\n  return false\r\n}\r\n\r\nfunction resetgeo(){\r\n    m.removeLayer(marker);\r\n    m.setView(old.center, old.zoom);\r\n}\r\n$(\"#geocoder\").submit(geocode);\r\n$(\"#resetgeo\").click(resetgeo);\r\n$(\"#getStatus\").change(function(){\r\n      var val = $(\"#getStatus\").val();\r\n      if(val==\"\"){\r\n        url.rmW(\"Progress\");\r\n      }else{\r\n        url.setW(\"Progress\",val)  \r\n      }\r\n      redo()\r\n    });\r\n$(\"#getDi\").change(function(){\r\n      var val = $(\"#getDi\").val();\r\n      if(val==\"\"){\r\n        url.rmW(\"Department\");\r\n      }else{\r\n        url.setW(\"Department\",val)  \r\n      }\r\n      redo()\r\n    });\r\nfunction makeAuto(d){\r\n   var f= d.features;\r\n   var len = d.features.length\r\n   var i = 0;\r\n   while(i<len){\r\n       if(!ac[f[i].attributes.ProjectNumber]){\r\n       ac[f[i].attributes.ProjectNumber]=d.geometryType;\r\n       }\r\n       i++;\r\n    }\r\nif(sw===0){sw++;}else if(sw===1){\r\n    sw--;\r\n    var a=[];\r\n    for(var k in ac){\r\n     a.push(k);   \r\n    }\r\n    \r\n$(\"#ProjNum\").autocomplete({source:a});\r\n}\r\n}\r\n$(\"#ProjLookUp\").submit(lookUp);\r\nvar b;\r\nfunction lookUp(){\r\n    b= [m.getCenter(),m.getZoom()];\r\n    var t= {esriGeometryPoint:\"point\",esriGeometryPolyline:\"line\"}\r\n    var v=$(\"#ProjNum\").val();\r\n    $.get(url[t[ac[v]]]+\"outFields=\"+url.fields+\"&where=ProjectNumber%3D%27\"+v+\"%27\"+url.end+bbox,parseLookUp,\"JSONP\");\r\n    function parseLookUp(data){\r\n        toGeoJSON(data,function(d){\r\n            lu.addData(d);\r\n            m.fitBounds(lu.getBounds());\r\n            });\r\n    };\r\n   \r\nreturn false\r\n}\r\n$(\"#ProjReset\").click(function(){\r\n    lu.clearLayers();\r\n    m.setView(b[0],b[1]);\r\n    })"]],"start1":0,"start2":0,"length1":0,"length2":6944}]],"length":6944}
{"contributors":[],"silentsave":false,"ts":1343929099955,"patch":[[{"diffs":[[0,"otile2\","],[-1,"/*"],[0,"\"otile3\""]],"start1":217,"start2":217,"length1":18,"length2":16},{"diffs":[[0,"otile3\","],[-1,"*/"],[0,"\"otile4\""]],"start1":226,"start2":226,"length1":18,"length2":16},{"diffs":[[0,"re={"],[-1,"\"Status\":\"Active\""],[0,"};\r\n"]],"start1":2734,"start2":2734,"length1":25,"length2":8}]],"length":6923,"saved":false}
{"contributors":[],"silentsave":false,"ts":1343995695177,"patch":[[{"diffs":[[0,"otile2\","],[1,"/*"],[0,"\"otile3\""]],"start1":217,"start2":217,"length1":16,"length2":18},{"diffs":[[0,"otile3\","],[1,"*/"],[0,"\"otile4\""]],"start1":228,"start2":228,"length1":16,"length2":18},{"diffs":[[0,");\r\n"],[-1,"var gj"],[1,"    //var g = L.layerGroup().addTo(m);\r\n//var gl =   L.geoJson({ \"type\": \"FeatureCollection\",  \"features\": []},{pointToLayer:pl,onEachFeature:gjon});\r\nvar gp"],[0," =  "]],"start1":668,"start2":668,"length1":14,"length2":165},{"diffs":[[0,";\r\n    }"],[-1,"\r\n    "],[0,"if(e.pro"]],"start1":1411,"start2":1411,"length1":22,"length2":16},{"diffs":[[0,"ies."],[-1,"Progres"],[1,"Statu"],[0,"s&&l.set"],[-1,"Style"],[1,"Radius"],[0,"){\r\n"]],"start1":1431,"start2":1431,"length1":28,"length2":27},{"diffs":[[0,"adius){\r\n       "],[1,"   "],[0,"if(e.properties."]],"start1":1449,"start2":1449,"length1":32,"length2":35},{"diffs":[[0,".properties."],[-1,"Progress==3"],[1,"Status==\"Completed\""],[0,"){\r\n        "]],"start1":1472,"start2":1472,"length1":35,"length2":43},{"diffs":[[0,"r:\"#"],[-1,"ff"],[1,"000\",fillColor:\"#"],[0,"0000"],[1,"ff"],[0,"\",fi"]],"start1":1531,"start2":1531,"length1":14,"length2":31},{"diffs":[[0,"ty:0.8,opacity:1"],[1,",weight:1"],[0,"});   \r\n       }"]],"start1":1569,"start2":1569,"length1":32,"length2":41},{"diffs":[[0,".properties."],[-1,"Progress==2"],[1,"Status==\"Active\""],[0,"){\r\n        "]],"start1":1619,"start2":1619,"length1":35,"length2":40},{"diffs":[[0,"r:\"#"],[-1,"ffff"],[1,"000\",fillColor:\"#ff00"],[0,"00\","]],"start1":1675,"start2":1675,"length1":12,"length2":29},{"diffs":[[0,"ty:0.8,opacity:1"],[1,",weight:1"],[0,"});   \r\n       }"]],"start1":1713,"start2":1713,"length1":32,"length2":41},{"diffs":[[0,"else"],[-1," if(e.properties.Progress==1)"],[0,"{\r\n "]],"start1":1754,"start2":1754,"length1":37,"length2":8},{"diffs":[[0,"color:\"#"],[1,"000\",fillColor:\"#"],[0,"00ff00\","]],"start1":1781,"start2":1781,"length1":16,"length2":33},{"diffs":[[0,"ty:0.8,opacity:1"],[1,",weight:1"],[0,"});   \r\n       }"]],"start1":1823,"start2":1823,"length1":32,"length2":41},{"diffs":[[0,"ies."],[-1,"Progres"],[1,"Statu"],[0,"s&&l.set"],[-1,"Icon){"],[1,"Style){\r\n        "],[0,"\r\n  "]],"start1":1888,"start2":1888,"length1":29,"length2":38},{"diffs":[[0,"ies."],[-1,"Progress==3){\r\n        l.setIcon(icon.red"],[1,"Status==\"Completed\"){\r\n        l.setStyle({color:\"#0000ff\",fillOpacity:0.8,opacity:1}"],[0,");  "]],"start1":1943,"start2":1943,"length1":49,"length2":93},{"diffs":[[0,"ies."],[-1,"Progress==2"],[1,"Status==\"Active\""],[0,"){\r\n"]],"start1":2064,"start2":2064,"length1":19,"length2":24},{"diffs":[[0,".set"],[-1,"Icon(icon.yellow);   \r\n       }else if(e.properties.Progress==1){\r\n        l.setIcon(icon.green"],[1,"Style({color:\"#ff0000\",fillOpacity:0.8,opacity:1});   \r\n       }else{\r\n        l.setStyle({color:\"#00ff00\",fillOpacity:0.8,opacity:1}"],[0,");  "]],"start1":2097,"start2":2097,"length1":103,"length2":141},{"diffs":[[0,"\r\n       }\r\n"],[1,"    \r\n"],[0,"    }\r\n}\r\n\r\n"]],"start1":2239,"start2":2239,"length1":24,"length2":30},{"diffs":[[0,"}\r\n}\r\n\r\n"],[1,"/*"],[0,"var icon"]],"start1":2261,"start2":2261,"length1":16,"length2":18},{"diffs":[[0," 9)})\r\n}"],[-1,""],[0,""],[1,"*/"],[0,"\r\n//get "]],"start1":2485,"start2":2485,"length1":16,"length2":18},{"diffs":[[0,"artment,"],[-1,"Progres"],[1,"Statu"],[0,"s\"\r\nurl."]],"start1":3027,"start2":3027,"length1":23,"length2":21},{"diffs":[[0,"on parse"],[-1,"JSONP"],[1,"Line(data){\r\n/*you'd think you'd want to put the command to clear the old layer here instead of after zooming, but the markers are not not visible when you zoom, so it ends up being much less noticeable clearing them earlier*/\r\n//toGeoJSON(data,function(d){gl.addData(d)});\r\nmakeAuto(data);\r\n//g.addLayer(gl).addLayer(gp);\r\n}\r\nfunction parsePoint"],[0,"(data){\r"]],"start1":3487,"start2":3487,"length1":21,"length2":362},{"diffs":[[0,"ion(d){g"],[-1,"j"],[1,"p"],[0,".addData"]],"start1":4085,"start2":4085,"length1":17,"length2":17},{"diffs":[[0,"data);\r\n"],[1,"//g.addLayer(gp)\r\n"],[0,"}\r\n//set"]],"start1":4119,"start2":4119,"length1":16,"length2":34},{"diffs":[[0,");\r\n    "],[-1,"gj"],[1," //g.clearLayers();\r\n   // gl.clearLayers();\r\n    gp"],[0,".clearLa"]],"start1":4351,"start2":4351,"length1":18,"length2":68},{"diffs":[[0,"l.end+bbox,parse"],[-1,"JSONP"],[1,"Point"],[0,",\"JSONP\");\r\n    "]],"start1":4846,"start2":4846,"length1":37,"length2":37},{"diffs":[[0,"ox,parse"],[-1,"JSONP"],[1,"Line"],[0,",\"JSONP\""]],"start1":4953,"start2":4953,"length1":21,"length2":20},{"diffs":[[0,"eturn L."],[-1,"m"],[1,"circleM"],[0,"arker(la"]],"start1":5009,"start2":5009,"length1":17,"length2":23},{"diffs":[[0,"arker(latlng"],[1,",{radius:4}"],[0,");\r\n}\r\n$(fun"]],"start1":5024,"start2":5024,"length1":24,"length2":35}]],"length":7665,"saved":false}
{"ts":1343995754576,"patch":[[{"diffs":[[0,",\"JSONP\");\r\n    "],[1,"//"],[0,"$.get(url.line+\""]],"start1":4867,"start2":4867,"length1":32,"length2":34}]],"length":7667,"saved":false}
{"ts":1343995927954,"patch":[[{"diffs":[[0,"  }\r\n}\r\n"],[1,"var markers = new L.MarkerClusterGroup();\r\nm.addLayer(markers);"],[0,"\r\n/*var "]],"start1":2259,"start2":2259,"length1":16,"length2":79},{"diffs":[[0,"    "],[-1,"return L.circleMarker(latlng,{radius:4})"],[1,"markers.addLayer(L.marker(latlng));\r\n     return true"],[0,";\r\n}"]],"start1":5069,"start2":5069,"length1":48,"length2":61}]],"length":7743,"saved":false}
{"ts":1343996036285,"patch":[[{"diffs":[[0,".properties));\r\n"],[1,"         markers.addLayer(l);\r\n"],[0,"    }if(e.proper"]],"start1":1398,"start2":1398,"length1":32,"length2":63},{"diffs":[[0,");\r\n"],[-1,"m.addLayer(markers);"],[0,"\r\n/*"]],"start1":2337,"start2":2337,"length1":28,"length2":8},{"diffs":[[0,"\n   "],[-1," markers.addLayer(L.marker(latlng));\r\n     return true"],[1,"\r\n     return L.marker(latlng)"],[0,";\r\n}"]],"start1":5079,"start2":5079,"length1":62,"length2":38}]],"length":7730,"saved":false}
{"ts":1343996126257,"patch":[[{"diffs":[[0,"r:pl"],[-1,",onEachFeature:gjon}).addTo(m"],[1,"}"],[0,");\r\n"]],"start1":904,"start2":904,"length1":37,"length2":9},{"diffs":[[0,"    "],[-1,"  l.bindPopup(makePop(e.properties));\r\n         markers.addLayer(l);"],[0,"\r\n  "]],"start1":1343,"start2":1343,"length1":76,"length2":8},{"diffs":[[0,"rGroup()"],[1,".addTo(m)"],[0,";\r\n\r\n/*v"]],"start1":2234,"start2":2234,"length1":16,"length2":25},{"diffs":[[0,"\n   "],[-1,"\r\n     return L.marker(latlng);"],[1," var l= L.marker(latlng)\r\n     l.bindPopup(makePop(f.properties));\r\n         markers.addLayer(l);\r\n    "],[0,"\r\n}\r"]],"start1":4992,"start2":4992,"length1":39,"length2":111}]],"length":7715,"saved":false}
{"ts":1343996166781,"patch":[[{"diffs":[[0,"rGroup()"],[-1,".addTo(m);\r\n"],[1,";\r\nm.addLayer(markers);"],[0,"\r\n/*var "]],"start1":2234,"start2":2234,"length1":28,"length2":39}]],"length":7726,"saved":false}
{"ts":1343996208928,"patch":[[{"diffs":[[0,");\r\n    "],[-1,"//"],[0,"var g = "]],"start1":668,"start2":668,"length1":18,"length2":16},{"diffs":[[0,"To(m);\r\n"],[-1,"//"],[0,"var gl ="]],"start1":702,"start2":702,"length1":18,"length2":16},{"diffs":[[0,"Layer:pl"],[1,",onEachFeature:gjon"],[0,"});\r\nvar"]],"start1":896,"start2":896,"length1":16,"length2":35},{"diffs":[[0,"es){\r\n      "],[-1,""],[0,""],[1,"  l.bindPopup(makePop(e.properties));"],[0,"\r\n    }if(e."]],"start1":1350,"start2":1350,"length1":24,"length2":61},{"diffs":[[0,"\n}\r\n"],[-1,"var markers = new L.MarkerClusterGroup();\r\nm.addLayer(markers);"],[0,""],[1,""],[0,"\r\n/*"]],"start1":2250,"start2":2250,"length1":71,"length2":8},{"diffs":[[0,"lier*/\r\n"],[-1,"//"],[0,"toGeoJSO"]],"start1":3702,"start2":3702,"length1":18,"length2":16},{"diffs":[[0,"akeAuto(data);\r\n"],[-1,"//"],[0,"g.addLayer(gl).a"]],"start1":3756,"start2":3756,"length1":34,"length2":32},{"diffs":[[0,");\r\n"],[-1,"//g.addLayer(gp)\r\n"],[0,"}\r\n/"]],"start1":4106,"start2":4106,"length1":26,"length2":8},{"diffs":[[0,";\r\n     "],[-1,"//"],[0,"g.clearL"]],"start1":4317,"start2":4317,"length1":18,"length2":16},{"diffs":[[0,"();\r\n   "],[-1,"//"],[0," gl.clea"]],"start1":4338,"start2":4338,"length1":18,"length2":16},{"diffs":[[0,");\r\n    "],[-1,"//"],[0,"$.get(ur"]],"start1":4836,"start2":4836,"length1":18,"length2":16},{"diffs":[[0,"    "],[-1,"var l= L.marker(latlng)\r\n     l.bindPopup(makePop(f.properties));\r\n         markers.addLayer(l);\r\n    "],[1,"return L.circleMarker(latlng,{radius:4});"],[0,"\r\n}\r"]],"start1":4965,"start2":4965,"length1":110,"length2":49}]],"length":7626,"saved":false}
{"ts":1343996290997,"patch":[[{"diffs":[[0,"ar bbox="],[-1,"/*"],[0,"m.getBou"]],"start1":2511,"start2":2511,"length1":18,"length2":16},{"diffs":[[0,"g();"],[-1,"*/\"-76.1627197265625,40.052847601823984,-65.9564208984375,44.57873024377564\";"],[0,"\r\n//"]],"start1":2544,"start2":2544,"length1":85,"length2":8},{"diffs":[[0,"events\r\n"],[-1,"//"],[0,"m.on(\"dr"]],"start1":4075,"start2":4075,"length1":18,"length2":16},{"diffs":[[0,"redo);\r\n"],[-1,"//"],[0,"m.on(\"zo"]],"start1":4098,"start2":4098,"length1":18,"length2":16},{"diffs":[[0,"){\r\n"],[-1,"    //"],[0,"bbox"]],"start1":4191,"start2":4191,"length1":14,"length2":8}]],"length":7537,"saved":false}
